#include "Calculatrice_App.h"
#include "Calculatrice.h"
#include "Clavier_4X4.h"
#include "ecran.h"

static uint16_t lire_nombre(void)
{
    uint16_t valeur = 0;

    LCD_command(0x01);
    LCD_String("Entrez nb:");

    while (1)
    {
        uint8_t donnee = valeur_clavier();
        if (donnee == 0) continue;

        if (donnee >= '0' && donnee <= '9')
        {
            valeur = valeur * 10 + (donnee - '0');
            LCD_Char(donnee);
        }
        else if (donnee == '*')
        {
            valeur = 0;
            LCD_command(0x01);
            LCD_String("Entrez nb:");
        }
        else if (donnee == '#')
        {
            return valeur;
        }
    }
}

static char lire_operateur(void)
{
    LCD_command(0x01);
    LCD_String("Operateur:");

    while (1)
    {
        uint8_t k = valeur_clavier();
        if (k == 0) continue;

        if (k == 'A') return '+';   // addition
        if (k == 'B') return '-';   // soustraction
        if (k == 'C') return '*';   // multiplication

        HAL_Delay(150);
    }
}

void Calculatrice_Run(void)
{
    Operandes op;

    LCD_command(0x01);
    LCD_String("CALCULATRICE");

    HAL_Delay(1000);

    while (1)
    {
        LCD_command(0x01);
        LCD_String("A=");
        op.a = lire_nombre();

        char operateur = lire_operateur();

        LCD_command(0x01);
        LCD_String("B=");
        op.b = lire_nombre();

        switch (operateur)
        {
            case '+': add(&op); break;
            case '-': sub(&op); break;
            case '*': mul(&op); break;
        }

        LCD_command(0x01);
        LCD_String("Res=");
        LCD_PrintInt(op.resultat);

        HAL_Delay(2000);
    }
}
