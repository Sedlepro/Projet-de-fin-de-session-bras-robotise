/*
 * Clavier_4X4.c
 *
 *  Created on: Nov 17, 2025
 *      Author: Sedrick
 */
#include "Clavier_4X4.h"
#include "main.h"

uint8_t etat_brut[4][4] = {0};
uint8_t etat_stables[4][4] = {0};
uint8_t etat_compteur[4][4] = {0};

static uint8_t ancien_etat[4][4];

void Clavier_Sel_ligne(uint8_t ligne)
{
	HAL_GPIO_WritePin(P1_0_GPIO_Port, P1_0_Pin, (ligne == 0) ? GPIO_PIN_RESET : GPIO_PIN_SET);
	HAL_GPIO_WritePin(P1_1_GPIO_Port, P1_1_Pin, (ligne == 1) ? GPIO_PIN_RESET : GPIO_PIN_SET);
	HAL_GPIO_WritePin(P1_2_GPIO_Port, P1_2_Pin, (ligne == 2) ? GPIO_PIN_RESET : GPIO_PIN_SET);
	HAL_GPIO_WritePin(P1_3_GPIO_Port, P1_3_Pin, (ligne == 3) ? GPIO_PIN_RESET : GPIO_PIN_SET);

	return;
}

uint8_t Clavier_lire_colonnes(void)
{
	uint8_t colonne = 0;

	if (HAL_GPIO_ReadPin(P1_4_GPIO_Port, P1_4_Pin) == GPIO_PIN_RESET)
	{
		colonne |= 0x01;
	}
	if (HAL_GPIO_ReadPin(P1_5_GPIO_Port, P1_5_Pin) == GPIO_PIN_RESET)
	{
		colonne |= 0x02;
	}
	if (HAL_GPIO_ReadPin(P1_6_GPIO_Port, P1_6_Pin) == GPIO_PIN_RESET)
	{
		colonne |= 0x04;
	}
	if (HAL_GPIO_ReadPin(P1_7_GPIO_Port, P1_7_Pin) == GPIO_PIN_RESET)
	{
		colonne |= 0x08;
	}

	return colonne;
}

void Clavier_donnee_brut(void)
{
	for (uint8_t x = 0; x < 4; x++)
	{
		Clavier_Sel_ligne(x);
		HAL_Delay(1);
		uint8_t colonne = Clavier_lire_colonnes();
		for (uint8_t y = 0; y < 4; ++y)
		{
			etat_brut[x][y] = (colonne & (1 << y) ? 1 : 0);
		}
	}
}

void Clavier_Debounce(void)
{
	uint8_t max = 4;

	for (uint8_t ligne = 0; ligne < 4; ++ligne)
	{
		for (uint8_t colonne = 0; colonne < 4; ++colonne)
		{
			if (etat_brut[ligne][colonne] != etat_stables[ligne][colonne])
			{
				etat_compteur[ligne][colonne]++;

				if (etat_compteur[ligne][colonne] >= max)
				{
					etat_stables[ligne][colonne] = etat_brut[ligne][colonne];
				}
			}
			else
			{
				etat_compteur[ligne][colonne] = 0;
			}
		}
	}
}

uint8_t valeur_clavier(void)
{
	const uint8_t touches[4][4] =
	{
		{'1','2','3','A'},
		{'4','5','6','B'},
		{'7','8','9','C'},
		{'*','0','#','D'}
	};

	Clavier_donnee_brut();
	Clavier_Debounce();

	for (uint8_t ligne = 0; ligne < 4; ++ligne)
	{
		for (uint8_t colonne = 0; colonne < 4; ++colonne)
		{
			if (etat_stables[ligne][colonne] == 1)
			{
				if (ancien_etat[ligne][colonne] != etat_stables[ligne][colonne] && ancien_etat[ligne][colonne] == 0)
				{
					ancien_etat[ligne][colonne] = etat_stables[ligne][colonne];
					return touches[ligne][colonne];
				}
			}
			ancien_etat[ligne][colonne] = 0;
		}
	}
	return 0x00;
}
